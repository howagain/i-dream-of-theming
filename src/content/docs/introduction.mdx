---
title: 'Introduction'
---

```css
/* This is an example of CSS variables */
:root {
  --css-variable: hsl(0, 0%, 100%); /* Declare a value */
  color: var(--css-variable); /* Use a value */
}
```

Today, we’ll talk about theming using **CSS variables** (a.k.a CSS custom properties) and how to use them to build beautiful and easy to manage sites.

By the end I hope you’ll have the knowledge of **how to build a dark theme that you can easily toggle on an off** for every app you work on in the future.

## What are CSS variables?

CSS variables are a way to store values in CSS that can be used in other CSS properties.

They are declared with `--` and used with `var()`. They are scoped to the element they are declared on.

```css
/* The root element is the html element or the shadowDOM root*/
:root {
  /* -- is required */
  --blue: #209ffb;
}
```

```css
.button {
  /* var is required */
  background: var(--blue);
}
```

### You can define fallbacks with `var()`.

```css
:root {
  /* if --primary isn't defined it will evaluate everything after the comma, so `var(--secondary, blue)``, Then if --secondary isn't defined it will evaluate white, which is valid and it will use */
  --background: var(--primary, var(--secondary, white));
}
```

_Note: If the first value is undefined it will use everything after the comma of the second. So in `var(--yellow, red, blue)` if `--yellow is undefined, it will return `red, blue`: (See MDN)[https://developer.mozilla.org/en-US/docs/Web/CSS/var]_

### You can use them anywhere you use CSS

TODO: Put into Codepen

#### In inline styles

```html
<div style="background: var(--blue);"></div>
```

#### In media queries

```css
@media (max-width: 500px) {
  .button {
    --blue: #209ffb;
    background: var(--blue);
  }
}
```

#### In pseudo classes

```css
.button:hover {
  --blue: #209ffb;
  background: var(--blue);
}
```

#### As partial values in compound values

```css
.button {
  --blue: #209ffb;
  background: linear-gradient(var(--blue), #fff);
}
```

#### Even in mathmatical expressions

```css
.button {
  --padding: 10;
  padding: calc(var(--padding) * 2px);
  /* Note that calc(var(--pading)px * 2) would not work as a trailing space is added and (10 px * 2) != (10 * 2px) */
  /* Also padding: var(--padding)px is invalid for the same trailing space reason */
}
```

## Why use CSS variables

- They are **semantic** so you don't have to remember random value.
- They are **easy to change** and can be used to manage global values.
- They are **dynamic** and can be changed with javascript.
- They are **inheritable** and can be used to build a theme.
- They are **scoped** and can be used to build a component.
- They are **responsive** and can be used in media queries.
- They are **pieceing** of the shadowDOM so you can style web components

### The power of CSS made dynamic

While often the neglected child, css is powerful.

Take a look at [CSS Zen Garden](http://www.csszengarden.com/) for an example of what css can do.

With the same html and different css, you can create completely different sites.

But imagine having to change between all of these sites. You'd esentially have to start from scratch each time

So CSS is powerful, but it’s also hard to maintain.

But with CSS variables, we can apply a single class and completely change the look and feel of our site.

## What will we learn?

My goal is that your css will evolve from this:

#### No Variables

```css
button {
  background-color: #1e90ff;
}
```

#### Basic

````css
```css :root {
  --blue: #1e90ff;
}

button {
  background-color: var(--blue);
}
````

#### Intermediate

```css
:root {
  --light-primary: #1e90ff;
  --primary-background: var(--primary, var(--light-primary));
}

.dark {
  --primary: #629aeb;
}

button {
  background: var(--primary-background);
}
```

#### Advanced

```css
:root {
  --primary-hue: 210;
  --primary-saturation: 100%;
  --primary-lightness: 56%;

  --primary-background: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));

  --primary-text: hsl(var(--primary-hue), var(--primary-saturation), 5%));

  --primary-hover: hsl(
    var(--primary-hue),
    var(--primary-saturation),
    calc(var(--primary-lightness) + 10%)
  );
}

.dark {
	--primary-saturation: 60%;
  --primary-lightness: 70%;
}

button {
  background: var(--primary-background);
	color: var(--primary-text);
}

button:hover {
	background: var(--primary-hover);
}
```

#### Superhero

```svelte
<script>
  const colorVariables = {}

  const generateColorScheme = (hct:string) => {...}

  const checkForAccessibility = (colorArray:string[]) => {...}

  const colorToLCH = (color:string) => {...}

  const colorToHSL = (color:string) => {...}

  const applyColorsToGlobal = (colorObject) => {...}

</script>

<style>
  global(*) {
    --primary-base: 210%, 100%;
    --primary-lightness: 56%;
    --primary-background: hsl(var(--primary-base), var(--primary-lightness));
  }

  .dark {
    --primary-lightness: 70%;
  }

  button {
    background: var(--primary-background);
    color: var(--primary-text);
  }

  button:hover {
    background: var(--primary-hover);
  }
</style>
```

## How are CSS Variables constructed by the browser?

To understand how CSS variables work, their power, and their limitations, it's important that we don't skip over how the CSS you write is actually parsed and interpreted by the browser.

### CSS Object Model (CSSOM)

![CSSOM and the DOM](/CSSOM-and-DOM.avif)
[Constructing the Object Model](https://web.dev/critical-rendering-path-constructing-the-object-model/)

When the browser starts parsing a CSS file, it converts the file into a series of tokens. **These tokens, which include selectors, properties, and values, are then organized into a tree-like structure called the CSS Object Model (CSSOM)**. The CSSOM is a parallel and analogous data structure to the Document Object Model (DOM) and is used to match elements in the DOM with the corresponding styles and apply them to the elements.

### How are properties assigned in the CSSOM?

![CSSOM Tree](/CSSOM-tree.jpeg)
[Converting CSS to the CSSOM](https://www.youtube.com/watch?v=-CATiyw2-Ns)

TODO: Insert Codepen to show the below especially overwriting css is possible

The CSSOM tree is built by passing down properties from parent nodes to child nodes. These are inherited or computed properties. The browser also checks media queries and will only add a rule set to the CSSOM tree if it applies to the current viewport. Futhermore, it will ignore any rules that are not valid.

Most importantly, **if the browser finds a duplicate selector, it will overwrite the previous rule set with the new one.** This is why CSS is render blocking, because the browser has to wait for the CSSOM to be complete before it can understand how to paint an element. It's also why **CSS variables cannot be evaluated until the CSSOM is complete** and leads to some of the quirks that we'll talk about next.

### How are CSS Variables Evaluated?

CSS variables are inherited by checking up the scope in the CSSOM. Since CSS can be redefined by later rules, **the browser does not know the value of CSS variables them when it is constructing the CSSOM. Therefore, they cannot be used in a way that would cause a recalculation the CSSOM**. Remember invalid rules are ignored by the browser. So if you try to use a CSS variable and it is invalid, the browser will default to it's initial styles.

## CSS Varaible Gotchas

Since variables only have a value after the CSSOM parsing is complete, there are some things that you can't do with them. There is a (proposal)[https://drafts.csswg.org/css-env-1/] to add in `env()` which would be similar to `var()` but not allow redefining the variable. This would allow for some of the use cases that we'll talk about below, but this is still in the draft stage.

### You can’t use them to define a selector

```css
:root {
  --my-property: color;
  --my-value: blue;
}

.my-element {
  /* this will not work, as --my-property is not a valid property */
  var(--my-property): var(--my-value);
}
```

This is because the browser doesn't know the value of the variable until it has parsed the entire CSSOM.

## You can't use them to define a media query

```css
:root {
  --mobile-breakpoint: 642px;
}

@media (max-width: var(--mobile-breakpoint)) {
}
```

[CSS native variables not working in media queries](https://stackoverflow.com/questions/40722882/css-native-variables-not-working-in-media-queries)

### You can't have a variable defined refrencing itself

```css
:root {
  --my-property: red;
}

button {
  /* This is invalid and would result in the browser using it's default styles */
  --my-property: var(--another-property, var(--my-property));
}
```

While `const myProperty = anotherProperty || myProperty;` is valid in JavaScript, the same pattern is not valid in CSS. Instead, if you wanted this fallback chain, you would want to define it like `--my-property: var(--another-property, red);`


## Naming CSS Variables

The hardest part will be an ever expanding set of variable names.

The first step that you might do with CSS is look at your style sheet and assign obvious values.
For example:

```css
:root {
  --blue: #012F6C;
}
```

However a better naming scheme would hint at the use of the variable for easier theming by other developers. For example:

```css
:root {
  --blue: #012F6C; /* option token */
  --background-color: var(--blue); /* decision token */
}
```

This gives other developers and your future self hints at what the variable should be used for and what will happen if it changes. This will help with accessibility edge cases where we need more granular control (such as red primary with error messages) that we'll talk about more later. Still for more complex values we may want to give them a name too. **So we want to define two levels of colors: one for the color values, the second for their use.** We refer to these as **option tokens** for the values and **decision tokens** for the use. For example if you're defining the text-color use a name like `--button-text-color` then for form elements define `--form-text-color`. This will help you keep your styles consistent and predictable.

## Building a Dark Theme with CSS variables

<p
  class="codepen"
  data-height="300"
  data-default-tab="css,result"
  data-slug-hash="YzjaBvB"
  data-editable="true"
  data-user="howagain"
  style="height: 300px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;"
>
  <span>
    See the Pen{" "}
    <a href="https://codepen.io/howagain/pen/YzjaBvB">Simple Toggle Switch</a>{" "}
    by howagain (<a href="https://codepen.io/howagain">@howagain</a>) on{" "}
    <a href="https://codepen.io">CodePen</a>.
  </span>
</p>
<script
  client:idle
  src="https://cpwebassets.codepen.io/assets/embed/ei.js"
></script>

### Defining the Theme
Some key points are to use dark grey rather than pure black, and to desaturate accent colors as they can cause eye strain. For more recommendations, see [Dark Mode Design Guidelines](https://m2.material.io/design/color/dark-theme.html#properties).


### Using CSS values to build a dark theme
Now we can build our dark theme by just reassigning the color values for primary.

```css
.dark-theme {
  --black: #000;
  --background-color: var(--black);
}
```

Now by simply applying the `.dark-theme` class to our body, we can change the theme of our site. Writing your styles in this manner limits their side effects and leads to a predicable system.

### Theming with CSS Variables

So far we have been using hex values for our colors. This is fine for simple sites, but for more complex sites we may want to use a color palette. This will allow us to have a consistent color scheme across our site. We can do this by defining a set of colors and then using them in our styles.

This can require computing relative colors, such as a lighter or darker version of a color. HSL (Hue, Saturation, Lightness) is a color model that can be used for easy relative color calculations with CSS variables. By separating out the hue, satuation, and lightness, we also can independently control our color and our pallette and generate a pallette from a single color.

For example:

```css
/* From astro's doc site */
:root {
  /*
		Variables with --color-base prefix define
		the hue, and saturation values to be used for
		hsla colors.

		Example:
		--color-base-{color}: {hue}, {saturation};
	*/

  --color-base-white: 0, 0%;
  --color-base-black: 240, 100%;
  --color-base-gray: 250, 14%;
  --color-base-orange: 22, 100%;
  --color-base-orange-dark: 22, 72%;

  /*
		Color palettes are made using --color-base 
		variables, along with a lightness value to
		define different variants.
	*/

  --color-gray-5: var(--color-base-gray), 5%;
  --color-gray-10: var(--color-base-gray), 10%;
  --color-gray-20: var(--color-base-gray), 20%;
  --color-gray-30: var(--color-base-gray), 30%;
  --color-gray-40: var(--color-base-gray), 40%;
  --color-gray-50: var(--color-base-gray), 50%;
  --color-gray-60: var(--color-base-gray), 60%;
  --color-gray-70: var(--color-base-gray), 70%;
  --color-gray-80: var(--color-base-gray), 80%;
  --color-gray-90: var(--color-base-gray), 90%;
  --color-gray-95: var(--color-base-gray), 95%;

  --color-orange: var(--color-base-orange), 50%;
}

:root {
  color-scheme: light;
  --theme-accent: hsla(var(--color-orange), 1);
  --theme-accent-secondary: hsl(324, 75%, 38%);
}

:root.theme-dark {
  color-scheme: dark;
  /* We lighten-up the orange in dark mode, to help with contrast. */
  --color-orange: var(--color-base-orange), 60%;
  --theme-bg: hsl(256, 27%, 19%);
  --theme-accent: hsla(var(--color-orange), 1);
}
```

If more control is needed you can also completely sepearte the hsl values and use them directly.

```css
:root {
  --orange-hue: 22;
  --orange-saturation: 100%;
  --orange-lightness: 50%;
  --color-orange: hsl(
    var(--orange-hue),
    var(--orange-saturation),
    var(--orange-lightness)
  );
}
```


While this may seem complicated, we've gained some impressive superpowers. We can theme our whole site from a central location by just tweaking a few variables.

## Using JavaScript to Control CSS Variables

<p class="codepen" data-height="300" data-default-tab="css,result" data-slug-hash="PoBewpQ" data-editable="true" data-user="howagain" style="height: 300px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;">
  <span>See the Pen <a href="https://codepen.io/howagain/pen/PoBewpQ">
  Updating CSS Variables with JavaScript</a> by howagain (<a href="https://codepen.io/howagain">@howagain</a>)
  on <a href="https://codepen.io">CodePen</a>.</span>
</p>
<script client:idle async src="https://cpwebassets.codepen.io/assets/embed/ei.js"></script>

The true superpowers come when you combine CSS and JS together. CSS variables are great at centralized control, JS excels at dynamic control and advanced math. We can use JS to build a theme based on a set of variables. This allows us to build a theme that is accessible and predictable.

### How to access CSS variables in JS

This will work only if the variable is defined on the element itself. Because remember the CSSOM gives elements a calculated style. This however only accesses the literal element's style.

```js
const value = element.style.getPropertyValue("--my-var");
```

So if we define the variables in a seperate stylesheet we need to access the computed style.

If we want to access the computed value of the variable, we can use (`getComputedStyle`)[https://developer.mozilla.org/en-US/docs/Web/API/Window/getComputedStyle]:

```js
const value = getComputedStyle(element).getPropertyValue("--my-var");
```

### How to set CSS variables in JS

We can set CSS variables in JS by using `setProperty`:

```js
element.style.setProperty("--my-var", "red");
```

since we usually define our CSS variables on the root element, we can use `document.documentElement` to access it.

```js
document.documentElement.style.setProperty("--my-var", "red");
```

which would actually create a new inline style that would override the value of the variable, rather than changing the value of the variable itself. But the effect will still be the same due to the higher specificity.

### How to listen for CSS variable changes

So it requires [a bit of a hack](https://stackoverflow.com/questions/57934680/listen-to-css-variable-change), but it's possible to listen for changes to CSS variables. We can use the `MutationObserver` to listen for changes to the `style` attribute of the element. This will fire whenever a CSS variable is changed. It will not work for a variable defined in a stylesheet. But you could observe a whole inline `<style>` tag with the same method. We also could listen to `getComputedStyle` it has bad pefromance, so it would have to be throttled

```js
// Must be set as an inline style, this would not work if it was defined in a stylesheet
document.documentElement.style.setProperty("--var1", "my value");

// The current value of the variable
let value = "1";

const styleObserver = new MutationObserver((mutations) => {
  const currentValue = mutations[0].target.style.getPropertyValue("--var1");

  if (currentValue !== value) {
    // the variable has changed
    console.log("style value changed", currentValue);
    value = currentValue;
  }
});

styleObserver.observe(document.documentElement, {
  attributes: true,
  attributeFilter: ["style"],
});
```


## Accessilibity
One of the things I hope you noticed is that when we change colors it can get hard to read. 

This is due to contrast. Which is the perceived difference in luminance between two colors.

### Color perception is dependent on the surrounding context
![Same Color with Two Different Apparent Shades](https://developer.mozilla.org/en-US/docs/Web/Accessibility/Understanding_Colors_and_Luminance/yellowdotcheckershadow_dlyon.png)

> Our contrast, lightness, and color perception is affected by the context of the nearby colors, and other features of a design or image. This makes predicting contrast challenging. It is clearly not as simple as the distance or ratio between two colors.

So we'll be hamstrung if we rely just on math to calculate colors. Instead we need to use a combination of math and human judgement. 

### What you should check for?
1. Contast
2. Color vision deficits

#### Contrast
This is most imporant for text. 

The WCAG 2.0 standard defines a contrast ratio of 4.5:1 as the minimum for normal text and 3:1 for large text. For optimal reading it should be 7:1 or higher. You can use the [Contrast Checker](https://www.myndex.com/APCA/) to check your contrast and if it meets your use case. [You also can color contrst from your dev tools.](https://developer.chrome.com/docs/devtools/accessibility/contrast/)

For other UI elements, they can be below 3:1, especially if there are other deliminating elements such as shadows, borders, or whitespace, but you should still check them.

#### Color vision deficiencies
There are several types of color vision deficits. [You can see your website simulated with various color deficits through the render panel.](https://developer.chrome.com/blog/new-in-devtools-83/#vision-deficiencies) Since some people lack a complete set of cones you should avoid "pure" colors, which can be nearly invisible for some users. 


### A more automated approach
Material theme builder uses a more automated approach. It uses a color palette and a set of rules to generate a theme. It uses smart names to make it easy to understand what the color is used for. It also uses a color contrast checker to make sure the colors are accessible.

You can play around with their [theme builder](https://m3.material.io/theme-builder#/dynamic)

And if you want to use their functions in your source code

### Accessibility sources
[MDN - Web Accessibility: Understanding Colors and Luminance](https://developer.mozilla.org/en-US/docs/Web/Accessibility/Understanding_Colors_and_Luminance)
[web.dev - Color and contrast accessibility](https://web.dev/color-and-contrast-accessibility/)

## Future of CSS

CSS variables are a powerful tool for building a theme system. They allow us to build a theme that is accessible and predictable. But they are not the end of the story. There are many other features that are coming to CSS that will allow us to build even more powerful themes.

[CSS spec 5](https://www.w3.org/TR/css-color-5/) - Relative colors and color spaces

You can get use JS to get similar functionality today by translating color spaces and doing relative manipulation with colorjs.io[https://colorjs.io/]

Color-contrast
- [MDN - color-contrast](https://developer.mozilla.org/en-US/docs/Web/CSS/color-contrast)
- [New CSS color-contrast feature](https://youtu.be/B3_FfR7v5W4)



## Takeaways

- CSS variables are a powerful tool for building a theme system
- They are computed at runtime, so they can be changed at any time
- They can be used to build a theme that is accessible and predictable, with semantic names
  - Use names with constant values and then wrap those into names describe how the value will be used 
- You can change CSS variables in JS with `element.style.setProperty` and you can get the current value with `getComputedStyle`
- You can listen for changes to CSS variables with a MutationObserver
- You need to use human judegement to make sure your theme is accessible
  - Use a color contrast checker and color blindness to make sure the colors are accessible (3:1 for large text, 4.5 for small text, and 7:1 for reading)
  - Don't use pure hues and check with a color vision deficiency simulator
  - Stick to web standards when possible (error is red, success is green, etc)
- There are many other features that are coming to CSS that will allow us to build even more powerful themes

