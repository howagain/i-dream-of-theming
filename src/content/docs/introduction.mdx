```css
/* This is an example of CSS variables */
:root {
  --css-variable: hsl(0, 0%, 100%); /* Declare a value */
  color: var(--css-variable); /* Use a value */
}
```

Today, we’ll talk about theming using **CSS variables** (a.k.a CSS custom properties) and how to use them to build beautiful and easy to manage sites.

By the end I hope you’ll have the knowledge of **how to build a dark theme that you can easily toggle on an off** for every app you work on in the future.

## What are CSS variables?

CSS variables are a way to store values in CSS that can be used in other CSS properties.

They are declared with `--` and used with `var()`. They are scoped to the element they are declared on.

```css
/* The root element is the html element or the shadowDOM root*/
:root {
  /* -- is required */
  --blue: #209ffb;
}
```

```css
.button {
  /* var is required */
  background: var(--blue);
}
```

### You can define fallbacks with `var()`.

```css
:root {
  /* if --primary isn't defined it will evaluate everything after the comma, so `var(--secondary, blue)``, Then if --secondary isn't defined it will evaluate white, which is valid and it will use */
  --background: var(--primary, var(--secondary, white));
}
```

_Note: If the first value is undefined it will use everything after the comma of the second. So in `var(--yellow, red, blue)` if `--yellow is undefined, it will return `red, blue`: (See MDN)[https://developer.mozilla.org/en-US/docs/Web/CSS/var]_

### You can use them anywhere you use CSS
TODO: Put into Codepen

#### In inline styles

```html
<div style="background: var(--blue);"></div>
```

#### In media queries

```css
@media (max-width: 500px) {
  .button {
    --blue: #209ffb;
    background: var(--blue);
  }
}
```

#### In pseudo classes

```css
.button:hover {
  --blue: #209ffb;
  background: var(--blue);
}
```

#### As partial values in compound values

```css
.button {
  --blue: #209ffb;
  background: linear-gradient(var(--blue), #fff);
}
```

#### Even in mathmatical expressions

```css
.button {
  --padding: 10;
  padding: calc(var(--padding) * 2px);
  /* Note that calc(var(--pading)px * 2) would not work as a trailing space is added and (10 px * 2) != (10 * 2px) */
  /* Also padding: var(--padding)px is invalid for the same trailing space reason */
}
```

## Why use CSS variables

- They are **semantic** so you don't have to remember random value.
- They are **easy to change** and can be used to manage global values.
- They are **dynamic** and can be changed with javascript.
- They are **inheritable** and can be used to build a theme.
- They are **scoped** and can be used to build a component.
- They are **responsive** and can be used in media queries.
- They are **pieceing** of the shadowDOM so you can style web components

### The power of CSS made dynamic

While often the neglected child, css is powerful.

Take a look at [CSS Zen Garden](http://www.csszengarden.com/) for an example of what css can do.

With the same html and different css, you can create completely different sites.

But imagine having to change between all of these sites. You'd esentially have to start from scratch each time

So CSS is powerful, but it’s also hard to maintain.

But with CSS variables, we can apply a single class and completely change the look and feel of our site.

## What will we learn?

My goal is that your css will evolve from this:

#### No Variables

```css
button {
  background-color: #1e90ff;
}
```

#### Basic

````css
```css :root {
  --blue: #1e90ff;
}

button {
  background-color: var(--blue);
}
````

#### Intermediate

```css
:root {
  --light-primary: #1e90ff;
  --primary-background: var(--primary, var(--light-primary));
}

.dark {
  --primary: #629aeb;
}

button {
  background: var(--primary-background);
}
```

#### Advanced

```css
:root {
  --primary-hue: 210;
  --primary-saturation: 100%;
  --primary-lightness: 56%;

  --primary-background: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));

  --primary-text: hsl(var(--primary-hue), var(--primary-saturation), 5%));

  --primary-hover: hsl(
    var(--primary-hue),
    var(--primary-saturation),
    calc(var(--primary-lightness) + 10%)
  );
}

.dark {
	--primary-saturation: 60%;
  --primary-lightness: 70%;
}

button {
  background: var(--primary-background);
	color: var(--primary-text);
}

button:hover {
	background: var(--primary-hover);
}
```

#### Superhero

```svelte
<script>
  const colorVariables = {}

  const generateColorScheme = (hct:string) => {...}

  const checkForAccessibility = (colorArray:string[]) => {...}

  const colorToLCH = (color:string) => {...}

  const colorToHSL = (color:string) => {...}

  const applyColorsToGlobal = (colorObject) => {...}

</script>

<style>
  global(*) {
    --primary-base: 210%, 100%;
    --primary-lightness: 56%;
    --primary-background: hsl(var(--primary-base), var(--primary-lightness));
  }

  .dark {
    --primary-lightness: 70%;
  }

  button {
    background: var(--primary-background);
    color: var(--primary-text);
  }

  button:hover {
    background: var(--primary-hover);
  }
</style>
```

## How are CSS Variables constructed by the browser?

To understand how CSS variables work, their power, and their limitations, it's important that we don't skip over how the CSS you write is actually parsed and interpreted by the browser.

### CSS Object Model (CSSOM)

![CSSOM and the DOM](public/CSSOM-and-DOM.avif)
[Constructing the Object Model](https://web.dev/critical-rendering-path-constructing-the-object-model/)

When the browser starts parsing a CSS file, it converts the file into a series of tokens. **These tokens, which include selectors, properties, and values, are then organized into a tree-like structure called the CSS Object Model (CSSOM)**. The CSSOM is a parallel and analogous data structure to the Document Object Model (DOM) and is used to match elements in the DOM with the corresponding styles and apply them to the elements.

### How are properties assigned in the CSSOM?

![CSSOM Tree](public/CSSOM-tree.jpeg)
[Converting CSS to the CSSOM](https://www.youtube.com/watch?v=-CATiyw2-Ns)

TODO: Insert Codepen to show the below especially overwriting css is possible

The CSSOM tree is built by passing down properties from parent nodes to child nodes. These are inherited or computed properties. The browser also checks media queries and will only add a rule set to the CSSOM tree if it applies to the current viewport. Futhermore, it will ignore any rules that are not valid.

Most importantly, **if the browser finds a duplicate selector, it will overwrite the previous rule set with the new one.** This is why CSS is render blocking, because the browser has to wait for the CSSOM to be complete before it can understand how to paint an element. It's also why **CSS variables cannot be evaluated until the CSSOM is complete** and leads to some of the quirks that we'll talk about in a second.

### How is the page painted?

Once the CSSOM is complete, the browser then continues traversing the DOM, and for each element, it looks for the matching rule set in the CSSOM tree. When a match is found, the browser applies the properties to the element. If the element has a parent element, the browser also checks if the parent element has any inherited properties that should be applied to the element.

### How are CSS Variables Evaluated?

CSS variables are inherited by checking up the scope in the CSSOM. Since CSS can be redefined by later rules, **the browser does not know the value of CSS variables them when it is constructing the CSSOM. Therefore, they cannot be used in a way that would cause a recalculation the CSSOM**. Remember invalid rules are ignored by the browser. So if you try to use a CSS variable and it is invalid, the browser will default to it's initial styles.

## CSS Varaible Gotchas

Since variables only have a value after the CSSOM parsing is complete, there are some things that you can't do with them. There is a (proposal)[https://drafts.csswg.org/css-env-1/] to add in `env()` which would be similar to `var()` but not allow redefining the variable. This would allow for some of the use cases that we'll talk about below, but this is still in the draft stage.

### You can’t use them to define a selector

```css
:root {
  --my-property: color;
  --my-value: blue;
}

.my-element {
  /* this will not work, as --my-property is not a valid property */
  var(--my-property): var(--my-value);
}
```

This is because the browser doesn't know the value of the variable until it has parsed the entire CSSOM.

## You can't use them to define a media query

```css
:root {
  --mobile-breakpoint: 642px;
}

@media (max-width: var(--mobile-breakpoint)) {
}
```

[CSS native variables not working in media queries](https://stackoverflow.com/questions/40722882/css-native-variables-not-working-in-media-queries)

### You can't have a variable defined refrencing itself

```css
:root {
  --my-property: red;
}

button {
  /* This is invalid and would result in the browser using it's default styles */
  --my-property: var(--another-property, var(--my-property));
}
```

While `const myProperty = anotherProperty || myProperty;` is valid in JavaScript, the same pattern is not valid in CSS. Instead, if you wanted this fallback chain, you would want to define it like `--my-property: var(--another-property, red);`

## Building a Dark Theme with CSS variables

<p class="codepen" data-height="300" data-default-tab="css,result" data-slug-hash="YzjaBvB" data-editable="true" data-user="howagain" style="height: 300px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;">
  <span>See the Pen <a href="https://codepen.io/howagain/pen/YzjaBvB">
  Simple Toggle Switch</a> by howagain (<a href="https://codepen.io/howagain">@howagain</a>)
  on <a href="https://codepen.io">CodePen</a>.</span>
</p>
<script client:visible async src="https://cpwebassets.codepen.io/assets/embed/ei.js"></script>




### Naming CSS Variables

The hardest part will be an ever expanding set of variable names.

The first step that you might do with CSS is look at your style sheet and assign obvious values.
For example:

```css
:root {
  --white: #fff;
}
```

then you'd use them like this

    ```css
    .my-element {
      background: var(--white);
    }
    ```

However a better naming scheme would hint at the use of the variable for easier theming by other developers. For example:

```css
:root {
  --background-color: #fff;
}
```

This gives other developers and your future self hints at what the variable should be used for and what will happen if it changes. This will help with accessibility edge cases where we need more granular control (such as red primary with error messages) that we'll talk about more later. Still for more complex values we may want to give them a name too. **So we want to define two levels of colors: one for the color values, the second for their use.** We refer to these as **option tokens** for the values and **decision tokens** for the use. For example if you're defining the text-color use a name like `--button-text-color` then for form elements define `--form-text-color`. This will help you keep your styles consistent and predictable.

```css
:root {
  --white: #fff; /* option token */
  --background-color: var(--white); /* decision token */
}
```

Now we can build our dark theme by just reassigning the color values for primary.

```css
.dark-theme {
  --black: #000;
  --background-color: var(--black);
}
```
Now by simply applying the `.dark-theme` class to our body, we can change the theme of our site. Writing your styles in this manner limits their side effects and leads to a predicable system.


### Theming with CSS Variables
So far we have been using hex values for our colors. This is fine for simple sites, but for more complex sites we may want to use a color palette. This will allow us to have a consistent color scheme across our site. We can do this by defining a set of colors and then using them in our styles. 

This can require computing relative colors, such as a lighter or darker version of a color. HSL

```css

For example:

```css
 :root{

 }

```


### Scaling your design system to large applications

At some point you'll likely want to define variables for every part of your app that needs to be reused. Include following categories:
- Text (color, font, size, weight, line-height, letter-spacing)
- Forms (border, border-radius, background, color, font, size, weight, line-height, letter-spacing)
- Interactive elements (buttons, links, etc)
- Icons
- Shadows
- Borders
- Radius
- Backgrounds 
- Z-Index
- Grid (spacing, sizing, breakpoints)

This many variables can quickly grow out of control. To help with this you may want to limit the interface to parts that are logically connected and then use selectors to redefine scoped variable in edge cases. For example:

```css
  :root {
    --primary-color: #000;
    --error-color: #f00;
  }

  .red-theme: {
    --primary-color: #f55;
  }
  
  .red-theme .error {
    background-color: black;
  }

  .element {
    color: var(--primary-color);
  }

  .error {
    color: var(--error-color);
  }

  ```

This approach requires manual work to solve challenging edge cases, but it makes desiging new themes easy to understand. If you want a more automated approach we'll need to use JavaScript to solve this problem.

### Using JavaScript to build a theme

The first step is to define a set of variables that we want to use. We'll use the same categories as before, but we'll also add a few more.

```js
const variables = {
  text: {
    color: '#000',
    font: 'sans-serif',
    size: '16px',
    weight: '400',
    lineHeight: '1.5',
    letterSpacing: '0',
  },
  form: {
    border: '1px solid #000',
    borderRadius: '4px',
    background: '#fff',
    color: '#000',
    font: 'sans-serif',
    size: '16px',
    weight: '400',
    lineHeight: '1.5',
    letterSpacing: '0',
  },
  interactive: {
    button: {
      background: '#000',
      color: '#fff',
      font: 'sans-serif',
      size: '16px',
      weight: '400',
      lineHeight: '1.5',
      letterSpacing: '0',
    },
    link: {
      color: '#000',
      font: 'sans-serif',
      size: '16px',
      weight: '400',
      lineHeight: '1.5',
      letterSpacing: '0',
    },
  },
  icon: {
    color: '#000',
  },
  shadow: {
    color: '#000',
  },
  border: {
    color: '#000',
  },
  radius: {
    size: '4px',
  },
  background: {
    color: '#fff',
  },
  zIndex: {
    value: '1',
  },
  grid: {
    spacing: '16px',
    sizing: '12px',
    breakpoints: {
      mobile: '768px',
      tablet: '1024px',
      desktop: '1200px',
    },
  },
};
```

The ideal system would be able to automatically reconcile colors and use 




- What about accessibliity?
  - Motion
  - Contrast
  - Giving the user dedicated hints
- I’m building X project, how can I think through my color theme, I don’t need something so fancy
  - Use semantic color variables rather than specific values, allows for easy tweaking later and it’s easy to understand
  - Pick a name system, as always naming things is the hardest part of this
- What naming system would you recommend?
  - Start with the logical types of elements that you have on the page and connect them
  - I’d recommend thinking of the following categories
    - Text (color, font,
    - Forms
    - Interactive elements (buttons)
    - Icons
    - Shadows
    - Borders
    - Radius
    - Neutrals
  - The fewer colors the better
  - I would not necessarily recommend using css variables for spacing/sizing unless there is a special use case calls for it as it can have unintended effects of squishing content, I would instead recommend a 4px grid system.
- I’m using X system, how can I move fast and still build things
  - Not every system is designed to be flexible, but if you can define custom values, use css variables with a fallback color
- How does inheritance work
  - Most specific selector
    - Inline, Id, Class, element
  - Which properties cascade down and which don’t
    - Font/font colors
  - Shadow dom
    - Nothing but css properties pierce the veil
- How do I make a good dark mode?
  - Dark mode is designed to reduce eye strain
  - Pick a neutral shade of grey and reduce the saturation of your colors.
- What alternatives exist for theming?
  - Tailwind has a “dark” mode that you can enable
    - What if you want more than dark mode
  - Passing conditional props to your components
    - Clutters up your logic, especially if you don’t have a solution for prop drilling.
  - Use something like material-UI’s theming system
    - Context provider which a theme prop, but then tying into this requires css in js, which isn’t evil
      [Theming - Material UI](https://mui.com/material-ui/customization/theming/)
  - But none pierce the shadow dom

Showroom

- Best practices for using CSS variables
  - Use consistent naming conventions for your variables
    - Good naming is one of the hardest part of coding.
      - Easy example, this function is get masked value but what it’s actually doing is taking a number like this and turning It into this. So a more accurate name is convert or usd currency format. Both are accurate but one is helpful for inputs and outputs.
      - Name should give hints about use
      - So rather than #f73424 you could use —primary-background-color
      - The question to ask yourself is “how will someone who doesn’t understand this use this variable?”
      - So in this diagram, if I have black, I actually might want to break that into two separate colors based on use, maybe one for text color and one for shadow color, even if they’re the same. Because variables are evaluated at runtime you can also create variables for base colors if you want to keep your code even more dry
  - Organize your variables in a logical way, such as grouping them by element or component
  - Use fallbacks for browser compatibility
  - Avoid using !important, as it can make it harder to override the value later
- How to debug and troubleshoot CSS variables
  - Use browser developer tools to inspect the values of your variables
  - Use a preprocessor like Sass or Less to automatically generate fallbacks for older browsers
  - Use linting tools to catch errors in your CSS before they cause problems
- How to use CSS variables in conjunction with preprocessors like Sass or Less
  - Use preprocessors to define your variables and then reference them in your CSS
  - Use preprocessors to perform calculations and operations on your CSS variables
  - Use preprocessors to generate fallbacks for older browsers
- How to use CSS variables with JavaScript
  - Use JavaScript to dynamically update the value of your CSS variables
  - Use JavaScript to perform calculations and operations on your CSS variables
  - Use JavaScript to switch between different sets of CSS variables for different themes or layouts
- How to use CSS variables with CSS Grid and Flexbox
  - Use CSS variables to define the grid and flexbox layout properties, such as grid-template-columns and flex-wrap
  - Use CSS variables to define the grid and flexbox spacing properties, such as grid-gap and justify-content
  - Use CSS variables to define the grid and flexbox alignment properties, such as align-items and align-content
- How to use CSS variables with media queries

  - Use CSS variables to define the breakpoints for your media queries
  - Use CSS variables to define the styles that should be applied at different breakpoints
  - Use CSS variables to change the value of other CSS variables based on the screen size or device type.

- ideal theming system
  - Everything is based off of one color or 1 file
    - Different themes can be applied with one toggle
  - You have a designer that allows you to swap between colors or randomize other design aspects
  - You can select from common layouts for your elements
  - Visual editing of elements that snap to a customizable grid and use smart efficient css with responsive design
  -


 If you're building a design system for mutiplatform applicationtion, you may want to consider using a tool like [Style Dictionary](https://amzn.github.io/style-dictionary/#/) to help you manage your variables.

# I Dream of Theming

Ever night millions of people around the world blind themselves when they visit a website without a dark theme. But you can help by learning how to use css custom properties to build easy to manage themes. In doing so you can save not only your customers corneas but also the planet.

In the past, if you wanted to do a dark theme, you'd have to go into every element of your website, open a color picker, and tweak it until it looked how you wanted it to.

The ideal of this would be a simple toggle switch that just says “oh this is your light color site” and here's the dark one.

Sites have added that today but how can they accomplish this. Well here are the docs for Astro, notice their toggle switch. How does it work?

Their source code looks like this?

With one class at the top level they can influence all of the colors. More than that if you look at how they do it, they change these special properties, called css properties.


# So how do I use them?

Within 1 selector

have to be declared inside a selector, usual root or html so they are global

Inheritance

- CSSOM

You might start like this (css evolution 1)

But I’ll let you know that this is okay to avoid magic values but we can improve this scheme by following some better naming schemes.

css design system at C1

## what is this?

- a set of design tokens that both have named values corresponding to the magic value colors - option tokens
- It also contains a set of design tokens which are named after their use

Why are these good?

- Because blue and white are great but what happens when you change to dark mode, and your white becomes this magic grey

how do you do it?

- Because css variables require names it’s important to have your names give hints of use rather than value.
- So white becomes background-color
- It also allows you to fix edge cases where your text needs more contrast in a specific theme of your website

So what if you aren’t sure what to name your variable

- better to be more specific than less specific

# what if I want to make a dark theme

- recommend to choose slightly less saturated colors

# what if I want to make my colors relative?

- Calc can be used in combination
- you can do that with HSL easily if you need to stay in pure JS
- Here’s how Astro does it
- But hsl is not perceptually uniform

# how do I know if my theme is accessible?

- color perception depends on context (use image of orange in the shade)
- use contrast rather than hue difference - that’s why hcl is good because luminance is coming soon
- Also avoid “pure colors” as CVDs are due to color vision deficit
  - Good check is to check color contrast of 3:1 for large text and 4.5:1 for small text and at least 7:1 for reading
  - Then check with color vision deficits for the same rules
- I was not able to find an easy rule for all of this, the best tool that I found for generating themes where accessibility is considered is material theme builder

How do I test css variables?

- cypress has support for css variables
- Depending on your unit test framework - vitest with happy dom loads styles but seems like best in headless mode doesn’t, you can try using window.getComputedstyles to help you

What are some of the future things to look out for in theming?

- css spec 5
  - Relative colors
  -
  - Color-contrast -
    [New CSS color-contrast feature](https://youtu.be/B3_FfR7v5W4)
  - LCH (and labLCH)
